apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: sap-equip-app-build-task
spec:
  inputs:
    resources:
    - name: source
      type: git
  steps:
  - name: build-app
    image: quay.io/gatblau/art-java11
    env:
    - name: SAPG_URL
      value: https://sapgateway-app-with-swagger-amosonline-aws-01-sapgateway.apps.amosds.amosonline.io
    - name: FX_NAME
      value: start-build
    - name: APPLICATION_NAME
      value: sap-equip-jvm
    - name: BUILDER_IMAGE
      value: quay.io/gatblau/art-kube
    - name: CRYPTO_KEY_NAME
      value: sap-equip-jvm-image-keys-secret
    - name: SAPG_USER
      valueFrom:
        secretKeyRef:
          key: SAPG_USER
          name: sap-equip-app-creds-secret
    - name: SAPG_PASSWORD
      valueFrom:
        secretKeyRef:
          key: SAPG_PASSWORD
          name: sap-equip-app-creds-secret
    - name: SAP_EQUIP_API_USER
      valueFrom:
        secretKeyRef:
          key: SAP_EQUIP_API_USER
          name: sap-equip-app-creds-secret
    - name: SAP_EQUIP_PASSWORD
      valueFrom:
        secretKeyRef:
          key: SAP_EQUIP_PASSWORD
          name: sap-equip-app-creds-secret
    workingDir: /workspace/source
  - name: scan-app
    image: quay.io/gatblau/art-sonar
    env:
    - name: SONAR_URI
      value: https://sonarqube-amosonline-aws-01-sapgatewaycd.apps.amosds.amosonline.io
    - name: SONAR_PROJECT_KEY
      value: net.atos:sap-equip
    - name: SONAR_SOURCES
      value: src/
    - name: SONAR_BINARIES
      value: target/classes
    - name: SONAR_TOKEN
      valueFrom:
        secretKeyRef:
          key: SONAR_TOKEN
          name: sap-equip-app-creds-secret
    workingDir: /workspace/source
  - name: package-app
    image: quay.io/gatblau/art-java
    env:
    - name: ARTEFACT_NAME
      value: artisan-registry-amosonline-aws-01-sapgatewaycd.apps.amosds.amosonline.io/sap/sap-equip-jvm
    - name: BUILD_PROFILE
      value: package-app
    - name: FX_NAME
      value: start-build
    - name: ART_REG_USER
      valueFrom:
        secretKeyRef:
          key: ART_REG_USER
          name: sap-equip-app-creds-secret
    - name: ART_REG_PWD
      valueFrom:
        secretKeyRef:
          key: ART_REG_PWD
          name: sap-equip-app-creds-secret
    workingDir: /workspace/source
    volumeMounts:
    - name: keys-volume
      mountPath: /keys
  volumes:
  - name: keys-volume
    secret:
      secretName: sap-equip-app-keys-secret

---
apiVersion: v1
kind: Secret
metadata:
  name: sap-equip-app-creds-secret
type: Opaque
stringData:
  ART_REG_PWD: nxrpsap
  ART_REG_USER: admin
  SAP_EQUIP_API_USER: sapequip_user
  SAP_EQUIP_PASSWORD: AnEdSaRaPr
  SAPG_PASSWORD: EM0dlxKa
  SAPG_USER: sapg
  SONAR_TOKEN: 2828c55eb611365ec0401b9974e5683bbacba4ef

---
apiVersion: v1
kind: Secret
metadata:
  name: sap-equip-app-keys-secret
type: Opaque
stringData:
  root_rsa_key.pgp: |-
    -----BEGIN PGP PRIVATE KEY BLOCK-----
    Version: golang.org/x/crypto/openpgp - artisan-0.0.4-140121091550672-3098ef4fe6-alpha
    Comment: Cipher: AES128, Hash: SHA-256, RSA Bits: 2048, Created: 2021-01-14 09:25:33.520863 +0000 GMT m=+0.282797935
    Hash: AES128/SHA-256

    xcLYBGAADg0BCAC9cYoG2Yq5M06iNBpiWWUZFrzhw7ZeZdT5BKdfXsSxqcgRh4VG
    S5n5xPjxbZQWV+1FPjgGLlpZMXtCQfsoPdsKazrBwiBY49QMnxYskjv/rDvs+1HJ
    GWpapFm+MMo+f6MAsRvaufCflUjRGjowUwno5tUEmBTtfLyKEhEtc3zI+tf3Nqwo
    LgSt3GhtUmNidWqifCyz32IyAyasMvCQdxgEGeWJnk4d1oH0l5NOdB06P95sDI6s
    RGgMJ4i5+0jlMgctE4Zzy6FHRsd5PQyRMr5z/XyN5rxIwy8PTo4mEQ6Sa5hiXSm+
    vViCOCGlQ3WAPoPoIYj+E9qpP+YcnmP/FKOJABEBAAEACACss3HyFqWZekWIJ1ma
    KQa6HXlpk0KQweKqdOykS7+iezXxjQsZb1haU4/igFPNHrEmO7dVIzKoNyy31XDC
    WclysRhqhK96eY/ZRbowPcvGo9wpiV8gpjPHmCZb9RyaZz9RJSRQfMv4n143ieJc
    JYdWNAEj5ATID7vNXvUb6zlp+Xd9R7xRuaHeVAjd9Ko3aH1NoYxzGggV10d0GrZJ
    tWq9hF7DgXHwDAfu8hMY2xj45PG1KY+F07eSDC8utlS4TOh4s3iT3Bib3JEYyG4s
    1ZRrfmhyPC/ak9zUBTubPNHLuzRuosZdUhGxkOYbUMkUuVmO/a9zZ9k+Mtb39SKF
    oieVBAD23KuV+/AOJu+9tYCINIIrW1wAJjzG0U8yNrQStbTFKEPsBMUbwRWYsxuN
    yEJG7KajALtHubTF5VbD8xwpJdeVGw8HmDXAP8k/8VBwPDEUbbuRtkM/LoEfcI92
    ftrX4Zwf0dZlOT63ICTde2Jn0/R+cUU9p/0tC/FZAXR+xBKlVwQAxHTBkygMH3/M
    lLPPpPm5G167UPWGNdOieKrOq7g7mLyeuoKmPkxBxTYliirLChPLwb24BFmr3EgB
    2L6sIut8HxUiBpWIjRE4di8scmuoTDPT8SNrEtfInx8DlV6UznM5ULdD30WD6eFp
    JBGmClZR3rpAhRvgkxUStlCMamJRkh8D/3yOdhxfrC9lY3JwtJb4/MRMb9rxGttA
    YBsJl9DsyRDh036TCuqdrEUDlkZWiy3rk8pt5VDMx4XlIoDW6s1na1newv+rlHIN
    wXHVsfgiZLunbsypal8B8gWK9C1V3u8zAVyy3O2y/Y+8I3KdY/y43TskRE1YlcCa
    Dk1laPrEfmrNPjnNlXJvb3QtQW5kcmVzcy1NYWNCb29rLVByby0yLmxvY2FsICgy
    MDQ4IGtleXMsIGdlbmVyYXRlZCBvbiAyMDIxLTAxLTE0IDA5OjI1OjMzLjI1OTMy
    NCArMDAwMCBHTVQgbT0rMC4wMjEyNjIyNTkpIDx0ZXN0QEFuZHJlc3MtTWFjQm9v
    ay1Qcm8tMi5sb2NhbC5jb20+wsBoBBMBCAAcBQJgAA4NCRCguGkCfCvd5gIbAwIZ
    AQILBwIVCAAA01EIADB7d/sryxlfmFt7bkdZ2Yx90zKOKZa3sINSEEPh8VBuGqNE
    RzuHOLDr+LjDlSKXH3mv51g1XLeUfpe8QaXF+bLGlo3judQj0zeqkOv7rHmzI1BD
    KO+N0siaETxMTBM5HgDhV9LyN7xFb4LWm9ZbggEd2yAj6fDtWKJlJfXsQL5ylLgS
    648kA0pujcaKAFK3+AioQIFyA9inwBdQERL1hrNNbkSGAMyFwTRu5LbpTep5qRDf
    DLLqD3R920tylXg6bmBq+kJs579l+I2eJ/Mfeun7G05n6dJmdqs8nwi0AIzsaWtM
    O1QcZ4tnYfKc04RzjDMAmbNu3L2C5rQ2gL44XT/HwtgEYAAODQEIAMeggGEZstjS
    8TgKCD9gP7RpCWIo809uVgK8qv6LMfoXM1WY0S5woHg6L7MaX8OVdCTE4yx18OJP
    solSHcAmqoBPNWNq7XnXzWgEKoGMilSINjwTEjsmvOUBUqTCoBuHTRAbUixaMeRR
    h84AOyEcHHwMbs2WoH4BVaNv/1pIZhJIxSk+rI4i9teXESwhSvdSNDFecVFl7EEr
    XB93H0Iif3rOnQJ1nNt8dyR26kdk+TNDZItAklS17jj67L1m7nKpt5awLaw+gviw
    zN1/JvzkZHBdWkA/9jC+RFFg3eDDfjAOYEyOPYE+5HJd9l1gskJantunLk/hZvyP
    qHSCkXwTBNUAEQEAAQAH/iswg3X+nF4izUOFkCE+DqpWq0wMdg+yXHN9JDWsIeTs
    zhNv25oDjgRU+mrygtOK6zTlUA0Xe0VLXuIs3PjspKjb+j4HLVfWI7+kXxnmMSt2
    yN0YdzJLAEU/kwTIguFR1Y9ticrEvNSb+xjLnf9c2KDSA8sBEroQSdnxajq7PTIp
    H8SAxJesvMy0H3EERoAXw4hsKyp+fCPkA4agLOEU9D6MUAR/stqFpxbgagiD5KI9
    ba7H5qsvuST1p8b9ut9mDopub+9zQ7CKzV8pZ6VMZQJhFXwVOyZhyRFRij2U1n5F
    UvMNv0aErx1D1R5OPqjrN+bgkJHCr4wm3ONGMr0/WwEEAP/muzNc0xMfx4Z/2eUj
    dR1n3l410mwgz4J01buAkrMSTLBhI6rXEQaea0SJsbaZ/aWhsvA25vTIrgRIN3DK
    Z3r/dW6/lW1gKutI/qcNj8pF3kVhSugtv6ElagZa/IpNAg2JsdCkbNmYKyaaYoDd
    HK0o0Hadq7drqj4lEqAEoe6VBADHtDal8VHUtNnib2cqPWhaXPW1pMyrN3K8fxHF
    qbt3oa1fSDA2Z7ZbMPY8aQGUWUjsv/ZciAlJHtvH7eQmfGw7wFver1xQAbzlWq0d
    5v0H0TtAeG3D8IaVGujSOvTUKZwgWFxfyTtPFSYKM+tqoF+1wTO1y2RDBecA3g0X
    suBtQQQAjCOZUrNnvve0aWPANDWOgfdkztKY/LyVddve/ZilhJUQhzspk8ibVgMk
    i2zMa9eV8L9u4wyOBorgGF+lwk7m1esi23svyxxUCRKi7BrTlI1EWN0EKUxey21U
    iZqrNU3MGvyCgTnHDzA753oogH3IIFphR7cj1lM15TB/zu0cwXw+TMLAXwQYAQgA
    EwUCYAAODQkQoLhpAnwr3eYCGwwAAEkCCACN4z6fBXyhupA7FB8/pasB6cMmqFEE
    lAG1Clx/HhPWZN+347LUR34VgGD96qGnFY1Vx6nWfXHO5CByjcjwiRAUumEYII1i
    pY9I4H5wqR8hbG5ZF4QpG2olYXb+3uEBREftvM8EfOsVdx8HJEgQmDmXrXWUm/1b
    gjkX4Ny6wpzoCbd5/QQqnYqCx9e5ZitF61AcfV52ir+TfXypLC03Y6QbhPshiDqV
    AwS8tPAF3UGQk5YrLYKdZUseIpSSysja3i0MeQrsxn8hUGqEqgR+C99fIOmyJiuZ
    Y9tazb2cjKXQoFSE5PWB1NDfcdFNJgv8UHJWcnhPG7l8OjYbWzyTv5mN
    =0uFu
    -----END PGP PRIVATE KEY BLOCK-----

---
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: sap-equip-app-builder
spec:
  resources:
  - name: sap-equip-app-code-repo
    type: git
  params:
  - name: deployment-name
    type: string
    description: the unique name for this deployment
  tasks:
  - name: sap-equip-app-build-task
    taskRef:
      name: sap-equip-app-build-task
    resources:
      inputs:
      - name: source
        resource: sap-equip-app-code-repo

---
apiVersion: tekton.dev/v1beta1
kind: PipelineResource
metadata:
  name: sap-equip-app-code-repo
spec:
  params:
  - name: url
    value: https://gitlab.com/sap7/sap-equip.git
  type: git

---
apiVersion: triggers.tekton.dev/v1beta1
kind: EventListener
metadata:
  name: sap-equip-app
  labels:
    app.openshift.io/runtime: quarkus
spec:
  serviceAccountName: pipeline
  triggers:
  - bindings:
    - name: sap-equip-app
    template:
      name: sap-equip-app

---
apiVersion: v1
kind: Route
metadata:
  name: el-sap-equip-app
  labels:
    application: sap-equip-app-https
  annotations:
    description: Route for the Pipeline Event Listener.
spec:
  port:
    targetPort: "8080"
  tls:
    insecureEdgeTerminationPolicy: Redirect
    termination: edge
  to:
    kind: Service
    name: el-sap-equip-app

---
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerBinding
metadata:
  name: sap-equip-app
spec:
  params:
  - name: git-repo-url
    value: $(body.project.web_url)
  - name: git-repo-name
    value: $(body.repository.name)
  - name: git-revision
    value: $(body.commits[0].id)

---
apiVersion: triggers.tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: sap-equip-app
spec:
  resourcetemplates:
  - apiVersion: tekton.dev/v1beta1
    kind: PipelineResource
    metadata:
      name: $(params.git-repo-name)-git-repo-$(uid)
    spec:
      params:
      - name: revision
        value: $(params.git-revision)
      - name: url
        value: https://gitlab.com/sap7/sap-equip.git
      type: git
  - apiVersion: tekton.dev/v1beta1
    kind: PipelineRun
    metadata:
      name: $(params.git-repo-name)-app-pr-$(uid)
    spec:
      resources:
      - name: sap-equip-app-code-repo
        resourceRef:
          name: $(params.git-repo-name)-git-repo-$(uid)
      params:
      - name: deployment-name
        value: $(params.git-repo-name)
      serviceAccountName: pipeline
      pipelineRef:
        name: sap-equip-app-builder
  params:
  - name: git-repo-url
    description: The git repository url
  - name: git-repo-name
    description: The git repository name
  - name: git-revision
    description: The git revision
    default: master

---

error: cannot decrypt registry username for package 'artisan-registry-amosonline-aws-01-sapgatewaycd.apps.amosds.amosonline.io/tekton/bc-launcher' - cannot decode the PGP armor encrypted string: EOF
error: cannot decrypt registry password for package 'artisan-registry-amosonline-aws-01-sapgatewaycd.apps.amosds.amosonline.io/tekton/bc-launcher' - cannot decode the PGP armor encrypted string: EOF
