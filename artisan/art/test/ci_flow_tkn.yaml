apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: java-app-build-task
spec:
  resources:
    inputs:
    - name: source
      type: git
  steps:
  - name: build-app
    image: quay.io/artisan/java
    env:
    - name: PROJECT_ARTIFACT_ID
      value: sap
    - name: PROJECT_ARTIFACT_VERSION
      value: 0.0.1
    - name: OXART_FX_NAME
      value: build-app
    workingDir: /workspace/source
    volumeMounts:
    - name: files-volume
      mountPath: /files
  - name: scan-app
    image: quay.io/artisan/sonar
    env:
    - name: SONAR_URI
      value: https://sonarqube-amosonline-aws-01-sapgatewaycd.apps.amosds.amosonline.io
    - name: SONAR_PROJECT_KEY
      value: net.atos:sap-quarkus
    - name: SONAR_SOURCES
      value: src/
    - name: SONAR_BINARIES
      value: target/classes
    - name: SONAR_TOKEN
      valueFrom:
        secretKeyRef:
          key: SONAR_TOKEN
          name: java-app-creds-secret
    workingDir: /workspace/source
  - name: package-app
    image: quay.io/artisan/java
    env:
    - name: APP_PACKAGE_NAME
      value: artisan-registry-amosonline-aws-01-sapgatewaycd.apps.amosds.amosonline.io/sap/sap-quarkus
    - name: ART_REG_USER
      valueFrom:
        secretKeyRef:
          key: ART_REG_USER
          name: java-app-creds-secret
    - name: ART_REG_PWD
      valueFrom:
        secretKeyRef:
          key: ART_REG_PWD
          name: java-app-creds-secret
    - name: SIGNING_KEY
      value: /
    - name: OXART_FX_NAME
      value: publish-app
    workingDir: /workspace/source
    volumeMounts:
    - name: keys-volume
      mountPath: /keys
  - name: build-image
    image: quay.io/artisan/k8s
    env:
    - name: BC_APPLICATION_NAME
      value: java-app
    - name: BC_BUILDER_IMAGE
      value: quay.io/artisan/buildah
    - name: BC_PUSH_IMAGE_REGISTRY
      value: registry.gitlab.com
    - name: BC_PUSH_IMAGE_REPO
      value: pratik10596
    - name: BC_PUSH_IMAGE_NAME
      value: java-app
    - name: BC_PUSH_IMAGE_VERSION
      value: quarkus-cicd
    - name: BC_PULL_IMAGE_REGISTRY
      value: registry.gitlab.com
    - name: BC_PACKAGE_NAME
      value: artisan-registry-amosonline-aws-01-sapgatewaycd.apps.amosds.amosonline.io/sap/sap-quarkus
    - name: BC_FX_NAME
      value: build-image
    - name: BC_CRYPTO_KEY_EMAIL
      value: test@vm-sapg01.com
    - name: BC_PULL_IMAGE_REGISTRY_UNAME
      valueFrom:
        secretKeyRef:
          key: BC_PULL_IMAGE_REGISTRY_UNAME
          name: java-app-creds-secret
    - name: BC_PULL_IMAGE_REGISTRY_PWD
      valueFrom:
        secretKeyRef:
          key: BC_PULL_IMAGE_REGISTRY_PWD
          name: java-app-creds-secret
    - name: BC_PUSH_IMAGE_REGISTRY_UNAME
      valueFrom:
        secretKeyRef:
          key: BC_PUSH_IMAGE_REGISTRY_UNAME
          name: java-app-creds-secret
    - name: BC_PUSH_IMAGE_REGISTRY_PWD
      valueFrom:
        secretKeyRef:
          key: BC_PUSH_IMAGE_REGISTRY_PWD
          name: java-app-creds-secret
    - name: BC_REGISTRY_USER
      valueFrom:
        secretKeyRef:
          key: BC_REGISTRY_USER
          name: java-app-creds-secret
    - name: BC_REGISTRY_PWD
      valueFrom:
        secretKeyRef:
          key: BC_REGISTRY_PWD
          name: java-app-creds-secret
    - name: VERIFICATION_KEY
      value: /
    - name: OXART_FX_NAME
      value: build-image
    workingDir: /workspace/source
    volumeMounts:
    - name: keys-volume
      mountPath: /keys
  volumes:
  - name: keys-volume
    secret:
      secretName: java-app-keys-secret
  - name: files-volume
    secret:
      secretName: java-app-files-secret

---
apiVersion: v1
kind: Secret
metadata:
  name: java-app-creds-secret
type: Opaque
stringData:
  ART_REG_PWD: nxrpsap
  ART_REG_USER: admin
  BC_PULL_IMAGE_REGISTRY_PWD: pratik786786
  BC_PULL_IMAGE_REGISTRY_UNAME: pratik10596
  BC_PUSH_IMAGE_REGISTRY_PWD: pratik786786
  BC_PUSH_IMAGE_REGISTRY_UNAME: pratik10596
  BC_REGISTRY_PWD: nxrpsap
  BC_REGISTRY_USER: admin
  SONAR_TOKEN: 2569e9f0d2a96a57067c604d8502e3e909fd8244

---
apiVersion: v1
kind: Secret
metadata:
  name: java-app-keys-secret
type: Opaque
stringData:
  root_rsa_key.pgp: |-
    -----BEGIN PGP PRIVATE KEY BLOCK-----
    Hash: AES128/SHA-256
    Version: golang.org/x/crypto/openpgp - artisan-0.0.4-010221210958628-c01c04c8b5-alpha
    Comment: Cipher: AES128, Hash: SHA-256, RSA Bits: 2048, Created: 2021-02-02 10:44:30.895093 +0000 GMT m=+0.255631745

    xcLYBGAZLQ4BCACvGShQ96yKtvs3ur3ktm2Q3njVogc8DmcehkB3xEw1ZptNoiTN
    T8XqK4qnYgHew8JehyoxBPIb+ymCJKHFHjYMciB0VWMHHZcwRlAzuXJK5L+CuUp4
    NV8TLOs1VGvRgpeYCtX2Qgh8uz7lcH2sa21cKxngMACRGNoq6HAo3qeHY0RY+pNW
    kUcHA0y9LuM4takcyaDVvnvLVP3Hga8Lf+Rfqu0RSlTBMYpUdgr8GoqCO7Qkm9PS
    D4eJ57Mq6KsmOtKWlUCKZqh1a/dlRiWZqh32mdKzyNGc5k5b0Qwi0MqqANXar/X3
    AXPX0HuJ8V8LTKJcYP7/GveQg7RWf3+P9F2RABEBAAEAB/0VitPR+lbJDjAkMB5y
    yBr8ytI0/mVDd0YqlDvUQFtb6o7K41sBw4HHCKpbY4x1WsJMHPcM5t3eoWz+7QDW
    HpxptZTWmza+xl42e0AczQEJw9DoBWHrHi3fTxR1EDjfouCBvTuLu54Nsn/PfKKJ
    lwHyZ/8b/Ovk7hjRVJ2P+azE1DZkwdB+r/P/aNspYOOhoH7uztWCDSeMmgs92imj
    5jybA65/EuuIn1giG+is7PPi3K1Wpum03LPZPXD1myv3JetcqIkQ1QI8UQltV8Zt
    iP5QJoXs9elb8fqxIuXhQkW/gIVRqsYqaXMPSQMPVUXQzLud5ChqLPaAi+6pCFvt
    pXtNBADnRDpEpXEhHJBsCKTmKfXeD8FZY0kilSFU1o74+LKqS1adH+SLe7cv9JxX
    E8ZCLpAKp+HbApgmExNM6kZvOSUK2k3zG8wzwHggp6cee7h4uswSN+WMh8KDh5+z
    Ws3tUf+Mu1etwUvBO9Y030uhuI0rOxYh2+k5sy5ZVTdUTWH5YwQAwdMeDprCZoP2
    6GGbQpr8Ga+ZflCPZWlVCLvxzny5NVc3qFe263sLRIQbhvyQ1fAFcdGub295Itrl
    eX3PzxO6e5zJKymDVvqCDhnA0Sn2uvIuRPYRG03dw21uXqZqNebOzxHRADHpd4fw
    7jtijUiByy8kgAk1+YGwcIhYfV2DuXsEALabzdeSnNh6J6mddK+mSNJOyZohsJOO
    lDi7EOTuF2VQfB7VAh0ES8xqP3slabE5SKfxXAl7XV+Eh3Ofki3Ek1AjfHTFfV8r
    Ou7a7hgsFnEqV2ZDuxr6kJnXgpu3+T6rU+54EgrkYjLXzt/x/ichAM8mcd3XINMJ
    NI1Iz6L2zQGVSA/NlXJvb3QtQW5kcmVzcy1NYWNCb29rLVByby0yLmxvY2FsICgy
    MDQ4IGtleXMsIGdlbmVyYXRlZCBvbiAyMDIxLTAyLTAyIDEwOjQ0OjMwLjY1MTkw
    MiArMDAwMCBHTVQgbT0rMC4wMTI0NDIwNzQpIDx0ZXN0QEFuZHJlc3MtTWFjQm9v
    ay1Qcm8tMi5sb2NhbC5jb20+wsBoBBMBCAAcBQJgGS0OCRD44+QWG/rHNQIbAwIZ
    AQILBwIVCAAAMDYIAFggKhQkxgR7r6mu3NpQ6cb79ZN6iD8CFvz5T9RI9bUxZPBL
    IQrXekNownoqfXrkUXKiaheVUDeheABENZjsl+8rBVeGLI4or7PIH4ci2SIXQ3Gw
    oWGuW+cFyuQd94dJYxm2ZuCV8At3DptQRAaQuGSuOL7cE/RQP9QUkTkopjovDTOt
    +BrYCYh7YY+oBDnxd6Rtld92ZwmUPiEveAIfJgV++86oWxjiA774pX8HEVqSNDTu
    lK2poTpFq4w0fJFg+Ux9oiuL9n1jpBM7UnHBM34Q5C8CTOSi7YHZO0k623W2VK5N
    CwQrNuY68mWC1HDRw3Igoy5aM5ZVaffHcKhDqtjHwtgEYBktDgEIAPR5RaqEbVri
    uW3+LdM9sy6lxY6fxwd2IT930A0xPUgkOJPaGZTqYUV5sdRB3ayk5kX703VRW3fL
    rC/nFMe2ltIKnQkVS76/Fixgc5LcHt8enhZa3fWPIFNX74pZ5p92Jsh1AmZDlyDn
    miIKEb5Ot9a9Li5YzWlq7cCb07dWFCOxyfjrY7kLXYWBolIKz7IcsYUUXIDB9sjj
    7A+Ht76nrQEeoERTrCwnjyL1XMqfQbf7rjy0Y6zLvC2TO/FHjYb5JheWzc30szvp
    geV2MyySnfqu7BJKeHXoplwj22NyKDniJFO7eiNjx+wj6pfel2YWkxvHVkAlQk5I
    GGXlqi04Wn0AEQEAAQAIAMhZCiqv1B6DZ4sons1a5xj3aWt0rVsECENHIQ1uqNYS
    OPuR5R0Q5x5UmNNmFxCBIuV/ds/SGK+YDkhDi9gPXpJLeF4VQbnUR4uej5hvJC2d
    ndicJwIyhT9H9VrgSgusfCQTICBGi/e/VaVHszrOsAIfj1UUGWKm6qjKCztYI7EL
    TGuuVWI4cdE4Uj9P1CJx8l3wxMRYKK/deBNKZO3FdbSnLIJpnf7jchFbUu9X5+lM
    63naejwzD8HLfYMaETfJS6SeWxF0tuk9lCKpezoEzZBv4eYilWPHcIe+A2OowLWY
    N420JfzWe/PVj4S+l58rZ0xLh7XkCgnUp176LBuOR4EEAP6bPQNBatMT4n5mgvFW
    Y5cJr36ZwNcoy5DkHHJu6BQWSO/W/m31VMrrpe10Qsr9z9ac/qgJ3A/ym/sKdxZ5
    pZUzA9BS65PEwfeyAZ9mc7ryI1BgUX3qiR6KI54XKoieE9Wz6UkmeeYdVgEIedwq
    9oic9iQzvUVwvj/EfyRj8vfVBAD1z9XqLcaKDfjjBVr4fK2o8bP6Ybpr8lrb3KU2
    Ilc7cgco+Wa0oYxZ17m6EEelrmJsue97z0I1v++mQ3VT54tpx30pOBOgZl+9cw1T
    VT/ao25eaELJIgxc6BE7P/tDG6OwYsrBzx1bTgZjnC0/VM/RfUJkA4qrVHqRjc/x
    do0UCQP/ZxSTmDhGfZVOPLOHsQtyA8EtAkARcoKadDw0ZE3DTd/NqVSEAtkVWUVa
    yCMfjBJvPXkgHHIaeLuk811ITYj5r5eSX6FZsqroNgn0Zv/KY6qfWO31uoETqViZ
    ZwWc/7tl+tjpu7TJbXV8Ce5DvxK8EFkiYcZi2fSU+FZL4QnnMlY6bMLAXwQYAQgA
    EwUCYBktDgkQ+OPkFhv6xzUCGwwAABhlCAB6RsHANvgOA07cYZeMSrZiGLa8HMwL
    I9iklTkMixyd4k5dxTjLX84l16JLj+rPx/lTpHOrDImEOU+43SRj6a4PIrXgLAPo
    AbCcEDSScXubMdya+QTdYP1O53JOKrFBqM1oG70nTtTdWEbng97tSbV+1XkYbMnO
    FWgXuZrJzCGLC+TR5lwSQ3c9nRWEOZC9283+7wEtM2EOR4UkFKoz6OFF0JQCTIr9
    giQ9TLS/OOWaevnb2Fp1Zldabok5Uyy8dLfX+E0EvZ1/tpucYk1buvfFPh/ZPEvI
    Mlz6/gg/B1bGKtbkFDB+GJR2bPimjokTokZPn4h0zWH5TWQA2z9WNAln
    =h0iH
    -----END PGP PRIVATE KEY BLOCK-----
  root_rsa_pub.pgp: |-
    -----BEGIN PGP PUBLIC KEY BLOCK-----
    Comment: Cipher: AES128, Hash: SHA-256, RSA Bits: 2048, Created: 2021-02-02 10:44:30.889748 +0000 GMT m=+0.250286851
    Hash: AES128/SHA-256
    Version: golang.org/x/crypto/openpgp - artisan-0.0.4-010221210958628-c01c04c8b5-alpha

    xsBNBGAZLQ4BCACvGShQ96yKtvs3ur3ktm2Q3njVogc8DmcehkB3xEw1ZptNoiTN
    T8XqK4qnYgHew8JehyoxBPIb+ymCJKHFHjYMciB0VWMHHZcwRlAzuXJK5L+CuUp4
    NV8TLOs1VGvRgpeYCtX2Qgh8uz7lcH2sa21cKxngMACRGNoq6HAo3qeHY0RY+pNW
    kUcHA0y9LuM4takcyaDVvnvLVP3Hga8Lf+Rfqu0RSlTBMYpUdgr8GoqCO7Qkm9PS
    D4eJ57Mq6KsmOtKWlUCKZqh1a/dlRiWZqh32mdKzyNGc5k5b0Qwi0MqqANXar/X3
    AXPX0HuJ8V8LTKJcYP7/GveQg7RWf3+P9F2RABEBAAHNlXJvb3QtQW5kcmVzcy1N
    YWNCb29rLVByby0yLmxvY2FsICgyMDQ4IGtleXMsIGdlbmVyYXRlZCBvbiAyMDIx
    LTAyLTAyIDEwOjQ0OjMwLjY1MTkwMiArMDAwMCBHTVQgbT0rMC4wMTI0NDIwNzQp
    IDx0ZXN0QEFuZHJlc3MtTWFjQm9vay1Qcm8tMi5sb2NhbC5jb20+wsBiBBMBCAAW
    BQJgGS0OCRD44+QWG/rHNQIbAwIZAQAAv90IAGX4EkyFuuusF8wR2iaAPRPb5s8T
    JVLDNZSGJAOmBxktbIHFmg0F1ZFswsGzWf/qtPCmsfUkgROIrX8r1Ar8WhouMgfQ
    8M8St1Tlyw7jM7m0wYyLkfM93xEoayFfZf2euL3t/7+PgjdyukEw8x+zVpqXZ0/s
    Brwx7Jp1+f7ZcCSPv3EiKX9pIijAyF2hw3JPXE0hvb7VMXHTMSFWS19Ee7OmLMv3
    PWTHP6i0GKoVoBD9xpAPwsC8ist0uEu7OJYSKYRGlZtJExef2YJIaoxEs/Z5GmfJ
    yZr9N5c7vpBO4GQb3RDhA/fYqjTzcydZ+wCCWECOeYRNRjO8cWVWgUSvr5nOwE0E
    YBktDgEIAPR5RaqEbVriuW3+LdM9sy6lxY6fxwd2IT930A0xPUgkOJPaGZTqYUV5
    sdRB3ayk5kX703VRW3fLrC/nFMe2ltIKnQkVS76/Fixgc5LcHt8enhZa3fWPIFNX
    74pZ5p92Jsh1AmZDlyDnmiIKEb5Ot9a9Li5YzWlq7cCb07dWFCOxyfjrY7kLXYWB
    olIKz7IcsYUUXIDB9sjj7A+Ht76nrQEeoERTrCwnjyL1XMqfQbf7rjy0Y6zLvC2T
    O/FHjYb5JheWzc30szvpgeV2MyySnfqu7BJKeHXoplwj22NyKDniJFO7eiNjx+wj
    6pfel2YWkxvHVkAlQk5IGGXlqi04Wn0AEQEAAcLAXwQYAQgAEwUCYBktDgkQ+OPk
    Fhv6xzUCGwwAABhlCAB6RsHANvgOA07cYZeMSrZiGLa8HMwLI9iklTkMixyd4k5d
    xTjLX84l16JLj+rPx/lTpHOrDImEOU+43SRj6a4PIrXgLAPoAbCcEDSScXubMdya
    +QTdYP1O53JOKrFBqM1oG70nTtTdWEbng97tSbV+1XkYbMnOFWgXuZrJzCGLC+TR
    5lwSQ3c9nRWEOZC9283+7wEtM2EOR4UkFKoz6OFF0JQCTIr9giQ9TLS/OOWaevnb
    2Fp1Zldabok5Uyy8dLfX+E0EvZ1/tpucYk1buvfFPh/ZPEvIMlz6/gg/B1bGKtbk
    FDB+GJR2bPimjokTokZPn4h0zWH5TWQA2z9WNAln
    =32sF
    -----END PGP PUBLIC KEY BLOCK-----

---
apiVersion: v1
kind: Secret
metadata:
  name: java-app-files-secret
type: Opaque
stringData:
  test.txt: |
    HELLO THIS IS A TEST FILE
    LINE 1
    LINE 2
    EOF

---
apiVersion: tekton.dev/v1alpha1
kind: Pipeline
metadata:
  name: java-app-builder
spec:
  resources:
  - name: java-app-code-repo
    type: git
  params:
  - name: deployment-name
    type: string
    description: the unique name for this deployment
  tasks:
  - name: java-app-build-task
    taskRef:
      name: java-app-build-task
    resources:
      inputs:
      - name: source
        resource: java-app-code-repo

---
apiVersion: tekton.dev/v1alpha1
kind: PipelineResource
metadata:
  name: java-app-code-repo
spec:
  params:
  - name: url
    value: https://gitlab.com/pratik10596/java-app.git
  type: git

---
apiVersion: triggers.tekton.dev/v1alpha1
kind: EventListener
metadata:
  name: java-app
  labels:
    app.openshift.io/runtime: quarkus
spec:
  serviceAccountName: pipeline
  triggers:
  - bindings:
    - name: java-app
    template:
      name: java-app

---
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: el-java-app
  labels:
    application: java-app-https
  annotations:
    description: Route for the Pipeline Event Listener.
spec:
  port:
    targetPort: "8080"
  tls:
    insecureEdgeTerminationPolicy: Redirect
    termination: edge
  to:
    kind: Service
    name: el-java-app

---
apiVersion: triggers.tekton.dev/v1alpha1
kind: TriggerBinding
metadata:
  name: java-app
spec:
  params:
  - name: git-repo-url
    value: $(body.project.web_url)
  - name: git-repo-name
    value: $(body.repository.name)
  - name: git-revision
    value: $(body.commits[0].id)

---
apiVersion: triggers.tekton.dev/v1alpha1
kind: TriggerTemplate
metadata:
  name: java-app
spec:
  resourcetemplates:
  - apiVersion: tekton.dev/v1alpha1
    kind: PipelineResource
    metadata:
      name: $(params.git-repo-name)-git-repo-$(uid)
    spec:
      params:
      - name: revision
        value: $(params.git-revision)
      - name: url
        value: https://gitlab.com/pratik10596/java-app.git
      type: git
  - apiVersion: tekton.dev/v1alpha1
    kind: PipelineRun
    metadata:
      name: $(params.git-repo-name)-app-pr-$(uid)
    spec:
      resources:
      - name: java-app-code-repo
        resourceRef:
          name: $(params.git-repo-name)-git-repo-$(uid)
      params:
      - name: deployment-name
        value: $(params.git-repo-name)
      serviceAccountName: pipeline
      pipelineRef:
        name: java-app-builder
  params:
  - name: git-repo-url
    description: The git repository url
  - name: git-repo-name
    description: The git repository name
  - name: git-revision
    description: The git revision
    default: master

---
apiVersion: tekton.dev/v1alpha1
kind: PipelineRun
metadata:
  name: java-app-pr-412567000
spec:
  resources:
  - name: java-app-code-repo
    resourceRef:
      name: java-app-code-repo
  params:
  - name: deployment-name
    value: java-app
  serviceAccountName: pipeline
  pipelineRef:
    name: java-app-builder

---
