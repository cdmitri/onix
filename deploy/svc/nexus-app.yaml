---
name: nexus-app
description: Nexus 3 repository manager
port: "8081"
var:
  - name: NEXUS_ADMIN_PASSWORD
    description: the nexus admin password
    secret: true
    value: ${fx=pwd:16,false}
volume:
  - name: nexus-data
    path: /nexus-data
init:
  - builder: compose
    scripts:
      - read_default_password
      - setup_nexus
scripts:
  - name: read_default_password
    description: |
      reads Nexus' default admin password from within the container's file system
      using docker exec command and writes the content to a temporary file
      note: this process should run outside of a container, as it needs to call the docker exec command
    content: |
      DEFAULT_PWD=
      echo "checking Nexus for temporary password file ..."
      while [ -z "$DEFAULT_PWD" ]
      do
        echo "waiting for nexus to create default admin password, please wait"
        sleep 5
        DEFAULT_PWD=$(docker exec ${bind-nexus-app} cat /nexus-data/admin.password)
      done
      echo $DEFAULT_PWD > temppwd
  - name: setup_nexus
    description: |
      updates the nexus default admin password, disables anonymous access and
      creates a hosted repository required by the artisan registry
      note: this process should run within a container attached to the application network
    runtime: ubi-min
    content: |
      DEFAULT_PWD=$(cat temppwd)

      echo wait for Nexus API
      art curl -X GET \
        -a 25 \
        http://${bind=nexus-app}:${bind=nexus-app:port}/service/rest/v1/status \
        -H 'accept: application/json'

      echo updating admin password from current temporary one
      art curl -X PUT \
        -u admin:${DEFAULT_PWD} \
        http://${bind=nexus-app}:${bind=nexus-app:port}/service/rest/v1/security/users/admin/change-password \
        -H 'accept: application/json','Content-Type: text/plain' \
        -d "${bind=nexus-app:var:NEXUS_ADMIN_PASSWORD}"

      rm temppwd

      echo creating new Artisan repository
      art curl -X POST \
        -u admin:${bind=nexus-app:var:NEXUS_ADMIN_PASSWORD} \
        http://${bind=nexus-app}:${bind=nexus-app:port}/service/rest/v1/repositories/raw/hosted \
        -H 'accept: application/json','Content-Type: application/json' \
        -d '{
        "name": "artisan",
        "online": true,
        "storage": {
          "blobStoreName": "default",
          "strictContentTypeValidation": true,
          "writePolicy": "allow"
        },
        "cleanup": {
          "policyNames": [
            "string"
          ]
        },
        "component": {
          "proprietaryComponents": true
        },
        "raw": {
          "contentDisposition": "ATTACHMENT"
        }
      }'

      echo disabling anonymous access
      art curl -X PUT \
        -u admin:${bind=nexus-app:var:NEXUS_ADMIN_PASSWORD} \
        http://${bind=nexus-app}:${bind=nexus-app:port}/service/rest/v1/security/anonymous \
        -H 'accept: application/json','Content-Type: application/json' \
        -d '{"enabled": false}'
...